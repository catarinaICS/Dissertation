%!TEX root = ../dissertation.tex

\chapter{Architecture}
\label{chapter:architecture}

The application developed follows a Model-View-Controller architecture.

This architecture is composed of three elements \cite{krasner1988description}:
\begin{itemize}
\item The Model, which captures and stores information about the application domain;
\item The View, which generates output based on the model state;
\item The Controller, which provides interaction between the Views and the Model. It is able to modify the Model and update the corresponding View.
\end{itemize}

The standard interaction cycle in this architecture is the following \cite{krasner1988description,reenskaug2009dci}:
\begin{itemize}
\item A user interacting with the application sends a request to the Controller.

\item The Controller communicates with the Model to apply the desired changes.

\item The Model is updated.

\item The Controller notifies the corresponding View so it can be updated with the new version of the Model.
\end{itemize}


\section{Model}
The Document is one of the most important entities of the Domain Model, because it aggregates all the concepts elicited during text analysis. 

Annotations are first added to the document before being linked to other domain entities, and all Software Architectures concepts discovered through reading are connected either directly or indirectly to this entity.

These annotations are constituted by a user comment, a tag and a selection of text from the document. Upon creation, an Annotation is associated with the corresponding Document and the User that created it. Figure \ref{figure:domainModel1} show these relations. The Annotation entity stores a String ``annotation'', which is a JSON representation of the annotation as it is used by the view.

\begin{figure}
\centering
\renewcommand {\umltextcolor}{black}
\renewcommand {\umlfillcolor}{none}
\renewcommand {\umldrawcolor}{black}

\begin{tikzpicture}
\begin{class}[text width=3cm ]{Document}{0,0}
	\attribute { title : String }
	\attribute { url : String }
	\attribute { content : String }
\end{class}

\begin{class}[text width=3.5cm ]{Annotation}{-2,-5}
	\attribute { annotation : String }
	\attribute { tag : String }
\end{class}

\begin{class}[text width=3.5cm ]{User}{-6,0}
	\attribute { username : String }
	\attribute { password : String }
	\attribute { firstName : String }
	\attribute { lastName : String}
	\attribute { type : String}
\end{class}
\association {Document}{document}{1}{Annotation}{annotations}{0..*}
\association {User}{owner}{1}{Annotation}{}{0..*}

\end{tikzpicture}
\caption{Domain Model: Document and Annotations}
\label{figure:domainModel1}
\end{figure} 

After creation, it can also be associated with one of the model entities that represent Software Architectures concepts, such as the Scenario and its elements, the Module or the View. 

As explained in Chapter \ref{chapter:concepts}, the Scenario contains a set of elements and a set of Tactics to achieve the quality requirement. Figure \ref{figure:domainModel2} shows how Scenarios and their elements are present in the Model. All elements - Source of Stimulus, Stimulus, Artifact, Environment, Response, Response Measure and the Tactics - are with a single Scenario. It does not make sense to have either of these elements without a Scenario, hence the 1 cardinality in the association between the scenario elements and the Scenario entity. Figure \ref{figure:domainModel2} also shows how Scenarios are associated to the corresponding document.

\begin{figure}
\centering
\renewcommand {\umltextcolor}{black}
\renewcommand {\umlfillcolor}{none}
\renewcommand {\umldrawcolor}{black}

\begin{tikzpicture}
\begin{class}[text width=3cm ]{Document}{9,-2.5}
	\attribute { title : String }
	\attribute { url : String }
	\attribute { content : String }
\end{class}

\begin{class}[text width=3cm ]{Scenario}{9,-7.5}
	\attribute { name : String}
	\attribute { identifier : String }
	\attribute { text : String }
\end{class}

\begin{class}[text width=3cm ]{SrcOfStimulus}{0,-1.5}
	\attribute { identifier : String }
	\attribute { text : String }
\end{class}	

\begin{class}[text width=3cm ]{Stimulus}{0,-3.5}
	\attribute { identifier : String }
	\attribute { text : String }
\end{class}

\begin{class}[text width=3cm ]{Artifact}{0,-5.5}
	\attribute { identifier : String }
	\attribute { text : String }
\end{class}

\begin{class}[text width=3cm ]{Environment}{0,-7.5}
	\attribute { identifier : String }
	\attribute { text : String }
\end{class}

\begin{class}[text width=3cm ]{Response}{0,-9.5}
	\attribute { identifier : String }
	\attribute { text : String }
\end{class}

\begin{class}[text width=3cm ]{ResponseMeasure}{0,-11.5}
	\attribute { identifier : String }
	\attribute { text : String }
\end{class}

\begin{class}[text width=3cm ]{Tactic}{0,-13.5}
	\attribute { identifier : String }
	\attribute { text : String }
\end{class}

\association {Scenario}{}{1}{SrcOfStimulus}{}{0..1}
\association {Scenario}{}{1}{Stimulus}{}{0..1}
\association {Scenario}{}{1}{Artifact}{}{0..1}
\association {Scenario}{}{1}{Environment}{}{0..1}
\association {Scenario}{}{1}{Response}{}{0..1}
\association {Scenario}{}{1}{ResponseMeasure}{}{0..1}
\association {Scenario}{}{1}{Tactic}{}{*}
\association {Scenario}{}{*}{Document}{}{0..1}

\end{tikzpicture}
\caption{Domain Model: Scenarios}
\label{figure:domainModel2}
\end{figure}

To facilitate programming, all Scenario elements are a subclass of a ``ScenarioElement'' class, as seen in the example in Figure \ref{figure:domainModel3}. This class contains a series of methods that are common to all the Scenario Elements.

\begin{figure}
\centering
\renewcommand {\umltextcolor}{black}
\renewcommand {\umlfillcolor}{none}
\renewcommand {\umldrawcolor}{black}

\begin{tikzpicture}

\begin{class}[text width=3cm ]{ScenarioElement}{0,0}
	\attribute { identifier : String }
	\attribute { text : String }
\end{class}

\begin{class}[text width=3cm ]{SrcOfStimulus}{0,-3}
	\inherit{ScenarioElement}
	\attribute { identifier : String }
	\attribute { text : String }
\end{class}	
	
\end{tikzpicture}
\caption{Domain Model: Scenario Elements}
\label{figure:domainModel3}
\end{figure}

As mentioned before, annotations can also be associated with Scenarios and Scenario Elements. This can be seen in Figure \ref{figure:domainModel4}.

\begin{figure}
\centering
\renewcommand {\umltextcolor}{black}
\renewcommand {\umlfillcolor}{none}
\renewcommand {\umldrawcolor}{black}

\begin{tikzpicture}
\begin{class}[text width=3.5cm ]{Annotation}{0,0}
	\attribute { annotation : String }
	\attribute { tag : String }
\end{class}
\begin{class}[text width=3cm ]{ScenarioElement}{-2,-4}
	\attribute { identifier : String }
	\attribute { text : String }
\end{class}

\begin{class}[text width=3cm ]{Scenario}{2,-4}
	\attribute { name : String }
	\attribute { identifier : String }
	\attribute { text : String }
\end{class}	
\association {Scenario}{}{0..1}{Annotation}{}{*}
\association {ScenarioElement}{}{0..1}{Annotation}{}{*}
\end{tikzpicture}
\caption{Domain Model: Scenarios and Scenario Elements and their relation with Annotations}
\label{figure:domainModel4}
\end{figure}

Figure \ref{figure:domainModel5} shows how Views and Modules relate with the Document. A View belongs, as mentioned in Chapter \ref{chapter:concepts}, to a certain viewtype, which is refined by a specific style. These details are present in the entity attributes. Views are associated with the corresponding Document after creation.
A View from the Module Viewtype contains Modules and the relationships between them. 
These Modules are created in a similar way as Scenarios or Views, and associated with the Document. Afterwards, they can be associated with Views.

\begin{figure}
\centering
\renewcommand {\umltextcolor}{black}
\renewcommand {\umlfillcolor}{none}
\renewcommand {\umldrawcolor}{black}
\begin{tikzpicture}
\begin{class}[text width=3.5cm ]{View}{0,0}
	\attribute { name : String }
	\attribute { viewtype : String }
	\attribute { style : String }
	\attribute { text : String }
\end{class}
\begin{class}[text width=3cm ]{Module}{-3,-4}
	\attribute { name : String }
	\attribute { identifier : String }
	\attribute { text : String }
\end{class}

\begin{class}[text width=3cm ]{Document}{3,-4}
	\attribute { title : String }
	\attribute { url : String }
	\attribute { content : String }
\end{class}	
\association {View}{}{*}{Document}{}{0..1}
\association {Module}{}{*}{Document}{}{0..1}
\association {Module}{}{*}{View}{}{*}

\end{tikzpicture}

\caption{Domain Model: Views and Modules}
\label{figure:domainModel5}
\end{figure}

Similarly to other entities, both the Module and View can have associated annotations, as seen in Figure \ref{figure:domainModel6}.

\begin{figure}
\centering
\renewcommand {\umltextcolor}{black}
\renewcommand {\umlfillcolor}{none}
\renewcommand {\umldrawcolor}{black}
\begin{tikzpicture}
\begin{class}[text width=3.5cm ]{View}{0,0}
	\attribute { name : String }
	\attribute { viewtype : String }
	\attribute { style : String }
	\attribute { text : String }
\end{class}
\begin{class}[text width=3cm ]{Module}{-3,-4}
	\attribute { name : String }
	\attribute { identifier : String }
	\attribute { text : String }
\end{class}

\begin{class}[text width=3cm ]{Annotation}{3,-4}
	\attribute { annotation : String }
	\attribute { tag : String }

\end{class}	
\association {View}{}{0..1}{Annotation}{}{*}
\association {Module}{}{0..1}{Annotation}{}{*}
\association {Module}{}{*}{View}{}{*}

\end{tikzpicture}

\caption{Domain Model: Views and Modules relationship with Annotations}
\label{figure:domainModel6}
\end{figure}

\begin{figure}
\centering
\renewcommand {\umltextcolor}{black}
\renewcommand {\umlfillcolor}{none}
\renewcommand {\umldrawcolor}{black}
\begin{tikzpicture}

\begin{class}[text width=3cm ]{Module}{-3,-4}
	\attribute { name : String }
	\attribute { identifier : String }
	\attribute { text : String }
\end{class}
	
%\association {Module}{}{0..1}{Module}{}{*}
\draw [umlcd style] (Module) -- (-3,-7) -- (0,-7) -- (0,-4.95) -- (Module);



\end{tikzpicture}

\caption{Domain Model: Module relationships (INCOMPLETO)}
\label{figure:domainModel6}
\end{figure}

\section{Controllers}

\subsection{Annotation Controller}
The Annotation Controller provides a way to manage the annotations added to a document. It communicates with the Domain Model to create, remove or update Annotations. The particularity of this controller is that it provides a REST API, which is used to retrieve a JSON representation of the annotations stored in the model and display it along with the document text. 
The endpoints provided by this controller are described in Table \ref{table:endpoints}.
\begin{table}
\begin{tabular}{ | l | l | l |p{7.7cm}|}
    \hline
    Name & Method & Endpoint & Description \\ \hline
    Index & GET & ../store/annotations & \parbox[t]{8cm}{Returns the set of annotations associated with a \\specific document }\\ \hline
    Read & GET & ../store/annotations/id & Returns the annotation with the specific id \\ \hline
    Create & POST & ../store/annotations & \parbox[t]{8cm}{Creates a new annotation, stores it in the model, \\and redirects to the Read endpoint} \\ \hline
    Update & PUT & ../store/annotations/id & \parbox[t]{8cm}{Updates the annotation with the given id and \\redirects to the Read endpoint} \\ \hline
    Delete & DELETE & ../store/annotations/id & \parbox[t]{8cm}{Removes the annotation with the given id. The \\response is a HTTP/1.0 204 NO CONTENT.} \\ \hline
  \end{tabular}
  \caption{REST API provided by the Annotation Controller}
  \label{table:endpoints}
\end{table}


\subsection{Document Controller}
The Document Controller handles the requests to view, add or remove a document from the system.

\subsection{Scenario Controller}
The Scenario Controller handles the construction of templates for Scenarios. All requests to create a new scenario, link document annotations to a specific scenario or delete a scenario are handled in this controller.




